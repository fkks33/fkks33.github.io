<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出発便フライト情報</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
            margin: 0;
            padding: 20px;
        }
        /* ★★★ プルダウンメニュー用のスタイルを追加 ★★★ */
        #controls {
            max-width: 800px;
            margin: 0 auto 20px auto;
            text-align: right;
        }
        #airport-selector {
            background-color: #3c3c3c;
            color: #f1f1f1;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 1em;
        }
        #flight-board {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #2a2a2a;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
        }
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #444;
        }
        thead {
            background-color: #1f1f1f;
            color: #ffffff;
            font-size: 1.1em;
        }
        tbody tr { background-color: #2a2a2a; }
        tbody tr:nth-child(even) { background-color: #3c3c3c; }
        tbody tr:hover { background-color: #555; }
    </style>
</head>
<body>
    
    <div id="controls">
        <label for="airport-selector">空港を選択: </label>
        <select id="airport-selector">
            <option value="ITM">大阪 (伊丹)</option>
            <option value="HND">東京 (羽田)</option>
            <option value="NRT">東京 (成田)</option>
            <option value="KIX">大阪 (関西)</option>
            <option value="FUK">福岡</option>
            <option value="KMJ">熊本</option>
        </select>
    </div>

    <table id="flight-board">
        <thead>
            <tr>
                <th>便名</th>
                <th>行先</th>
                <th>定刻</th>
                <th>変更時刻</th>
                <th>搭乗口</th>
                <th>備考</th>
            </tr>
        </thead>
        <tbody id="flight-data">
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const flightDataBody = document.getElementById('flight-data');
            const airportSelector = document.getElementById('airport-selector');
            const apiKey = '2f2b359ffbeb4e3db8fe82ca90f64637';

            // ★★★ 2. データ取得と表示の処理を関数化 ★★★
            const fetchAndDisplayFlights = (airportCode) => {
                const apiUrl = `http://api.aviationstack.com/v1/flights?access_key=${apiKey}&dep_iata=${airportCode}`;
                
                // データ取得前に「読み込み中」メッセージを表示
                flightDataBody.innerHTML = `<tr><td colspan="6">読み込み中...</td></tr>`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ネットワークの応答が正しくありませんでした。');
                        }
                        return response.json();
                    })
                    .then(apiData => {
                        // 新しいデータを表示する前に、テーブルの中身を空にする
                        flightDataBody.innerHTML = '';
                        
                        const flights = apiData.data;
                        if (!flights || flights.length === 0) {
                            flightDataBody.innerHTML = `<tr><td colspan="6">現在、表示できるフライト情報がありません。</td></tr>`;
                            return;
                        }
                        
                        flights.sort((a, b) => new Date(a.departure.scheduled) - new Date(b.departure.scheduled));

                        flights.forEach(flight => {
                            const flightNumber = flight.flight.iata ?? '---';
                            const destination = flight.arrival.airport ?? '---';
                            const gate = flight.departure.gate ?? '---';
                            
                            const timeFormatOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'UTC' };
                            const scheduledTime = new Date(flight.departure.scheduled).toLocaleTimeString('ja-JP', timeFormatOptions);
                            
                            let changedTimeText = '---';
                            const delayMinutes = flight.departure.delay;
                            if (delayMinutes && typeof delayMinutes === 'number') {
                                const scheduledDate = new Date(flight.departure.scheduled);
                                scheduledDate.setMinutes(scheduledDate.getMinutes() + delayMinutes);
                                changedTimeText = scheduledDate.toLocaleTimeString('ja-JP', timeFormatOptions);
                            }

                            const remarksParts = [];
                            if (flight.flight.codeshared !== null) { remarksParts.push('共同運行便'); }
                            if (flight.flight_status === 'landed') { remarksParts.push('出発済み'); }
                            const remarksText = remarksParts.join(' ') || '---';

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${flightNumber}</td>
                                <td>${destination}</td>
                                <td>${scheduledTime}</td>
                                <td>${changedTimeText}</td>
                                <td>${gate}</td>
                                <td>${remarksText}</td>
                            `;
                            flightDataBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('データの取得に失敗しました:', error);
                        flightDataBody.innerHTML = `<tr><td colspan="6">情報の取得中にエラーが発生しました。</td></tr>`;
                    });
            };

            // ★★★ 3. プルダウンの選択が変更されたら、新しい空港のデータを取得 ★★★
            airportSelector.addEventListener('change', (event) => {
                const selectedAirport = event.target.value;
                fetchAndDisplayFlights(selectedAirport);
            });

            // ★★★ 4. ページの初回読み込み時に、デフォルトの空港（ITM）のデータを取得 ★★★
            fetchAndDisplayFlights('ITM');
        });
    </script>

</body>
</html>
