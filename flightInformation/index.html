<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>伊丹空港 出発便フライト情報</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
            margin: 0;
            padding: 20px;
        }
        #flight-board {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #2a2a2a;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
        }
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #444;
        }
        thead {
            background-color: #1f1f1f;
            color: #ffffff;
            font-size: 1.1em;
        }
        tbody tr { background-color: #2a2a2a; }
        tbody tr:nth-child(even) { background-color: #3c3c3c; }
        tbody tr:hover { background-color: #555; }
    </style>
</head>
<body>
    
    <table id="flight-board">
        <thead>
            <tr>
                <th>便名</th>
                <th>行先</th>
                <th>定刻</th>
                <th>変更時刻</th> <th>搭乗口</th>
                <th>備考</th>
            </tr>
        </thead>
        <tbody id="flight-data">
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiUrl = 'http://api.aviationstack.com/v1/flights?access_key=2f2b359ffbeb4e3db8fe82ca90f64637&dep_iata=ITM';
            const flightDataBody = document.getElementById('flight-data');

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ネットワークの応答が正しくありませんでした。');
                    }
                    return response.json();
                })
                .then(apiData => {
                    const flights = apiData.data;
                    if (!flights || flights.length === 0) {
                        // 列が増えたのでcolspanを6に変更
                        flightDataBody.innerHTML = '<tr><td colspan="6">現在、表示できるフライト情報がありません。</td></tr>';
                        return;
                    }
                    
                    flights.sort((a, b) => new Date(a.departure.scheduled) - new Date(b.departure.scheduled));

                    flights.forEach(flight => {
                        const flightNumber = flight.flight.iata ?? '---';
                        const destination = flight.arrival.airport ?? '---';
                        const gate = flight.departure.gate ?? '---';
                        
                        const timeFormatOptions = { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: false, 
                            timeZone: 'UTC'
                        };

                        const scheduledTime = new Date(flight.departure.scheduled)
                            .toLocaleTimeString('ja-JP', timeFormatOptions);

                        // ★★★ 2. 変更時刻を計算するロジックを追加 ★★★
                        let changedTimeText = '---';
                        const delayMinutes = flight.departure.delay;

                        // delayがnullでなく、かつ数値である場合のみ計算
                        if (delayMinutes && typeof delayMinutes === 'number') {
                            const scheduledDate = new Date(flight.departure.scheduled);
                            // 元の時刻に遅延時間（分）を加算
                            scheduledDate.setMinutes(scheduledDate.getMinutes() + delayMinutes);
                            changedTimeText = scheduledDate.toLocaleTimeString('ja-JP', timeFormatOptions);
                        }

                        const remarksParts = [];
                        if (flight.flight.codeshared !== null) {
                            remarksParts.push('共同運行便');
                        }
                        if (flight.flight_status === 'landed') {
                            remarksParts.push('出発済み');
                        }
                        const remarksText = remarksParts.join(' ') || '---';

                        const row = document.createElement('tr');
                        // ★★★ 3. 行データに変更時刻を追加 ★★★
                        row.innerHTML = `
                            <td>${flightNumber}</td>
                            <td>${destination}</td>
                            <td>${scheduledTime}</td>
                            <td>${changedTimeText}</td>
                            <td>${gate}</td>
                            <td>${remarksText}</td>
                        `;
                        flightDataBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('データの取得に失敗しました:', error);
                    // 列が増えたのでcolspanを6に変更
                    flightDataBody.innerHTML = `<tr><td colspan="6">情報の取得中にエラーが発生しました。</td></tr>`;
                });
        });
    </script>

</body>
</html>
