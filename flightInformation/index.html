<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出発便フライト情報</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
            margin: 0;
            padding: 20px;
        }

        /* === 修正: プルダウンメニューのスタイル === */
        .select-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            margin-top: 10px;
        }

        #airport-select {
            font-size: 1em;
            color: #f1f1f1;
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px 15px;
            -webkit-appearance: none; /* 標準のスタイルを無効化 */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23f1f1f1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: .65em auto;
            min-width: 200px; /* 幅を確保 */
            cursor: pointer;
        }
        /* === 修正ここまで === */

        /* テーブル共通スタイル */
        #flight-board {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #2a2a2a;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
        }
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #444;
        }
        thead {
            background-color: #1f1f1f;
            color: #ffffff;
            font-size: 1.1em;
        }
        tbody tr { background-color: #2a2a2a; }
        tbody tr:nth-child(even) { background-color: #3c3c3c; }
        tbody tr:hover { background-color: #555; }

        /* カード表示用のスタイル */
        .flight-card-container {
            display: none;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 10px;
        }

        .flight-card {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .flight-card div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #3c3c3c;
        }

        .flight-card div:last-child {
            border-bottom: none;
        }

        .flight-card .label {
            font-weight: bold;
            color: #bbb;
            flex-basis: 30%;
            text-align: left;
        }

        .flight-card .value {
            color: #f1f1f1;
            flex-basis: 65%;
            text-align: right;
        }

        @media (max-width: 768px) {
            #flight-board {
                display: none;
            }
            .flight-card-container {
                display: block;
            }
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    
    <div class="select-container">
        <select id="airport-select">
            <option value="ITM" selected>伊丹空港 (ITM)</option>
            <option value="HND">羽田空港 (HND)</option>
            <option value="KMJ">熊本空港 (KMJ)</option>
        </select>
    </div>

    <table id="flight-board">
        <thead>
            <tr>
                <th>便名</th>
                <th>行先</th>
                <th>定刻</th>
                <th>変更時刻</th>
                <th>搭乗口</th>
                <th>備考</th>
            </tr>
        </thead>
        <tbody id="flight-data-table">
        </tbody>
    </table>

    <div id="flight-card-container" class="flight-card-container">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const flightDataTableBody = document.getElementById('flight-data-table');
            const flightCardContainer = document.getElementById('flight-card-container');
            // === 修正: プルダウン要素を取得 ===
            const airportSelect = document.getElementById('airport-select');

            const fetchAndDisplayFlights = (iataCode) => {
                const ACCESS_KEY = '2f2b359ffbeb4e3db8fe82ca90f64637';
                const apiUrl = `https://api.aviationstack.com/v1/flights?access_key=${ACCESS_KEY}&dep_iata=${iataCode}`;
                
                flightDataTableBody.innerHTML = '<tr><td colspan="6">読み込み中...</td></tr>';
                flightCardContainer.innerHTML = '<div class="flight-card"><div class="value" style="text-align:center;">読み込み中...</div></div>';

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error('ネットワークの応答が正しくありませんでした。');
                        return response.json();
                    })
                    .then(apiData => {
                        flightDataTableBody.innerHTML = '';
                        flightCardContainer.innerHTML = '';
                        
                        // === 修正: 共同運行便(codesharedがnullでないもの)を除外 ===
                        const flights = apiData.data.filter(flight => flight.flight.codeshared === null);

                        if (!flights || flights.length === 0) {
                            flightDataTableBody.innerHTML = `<tr><td colspan="6">${iataCode}発のフライト情報(共同運行便を除く)がありません。</td></tr>`;
                            flightCardContainer.innerHTML = `<div class="flight-card"><div class="value" style="text-align:center;">${iataCode}発のフライト情報(共同運行便を除く)がありません。</div></div>`;
                            return;
                        }
                        
                        flights.sort((a, b) => new Date(a.departure.scheduled) - new Date(b.departure.scheduled));

                        flights.forEach(flight => {
                            const flightNumber = flight.flight.iata ?? '---';
                            const destination = flight.arrival.airport ?? '---';
                            const gate = flight.departure.gate ?? '---';
                            const timeFormatOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'UTC' };
                            const scheduledTime = new Date(flight.departure.scheduled).toLocaleTimeString('ja-JP', timeFormatOptions);
                            let changedTimeText = '---';
                            const delayMinutes = flight.departure.delay;
                            if (delayMinutes && typeof delayMinutes === 'number') {
                                const scheduledDate = new Date(flight.departure.scheduled);
                                scheduledDate.setMinutes(scheduledDate.getMinutes() + delayMinutes);
                                changedTimeText = scheduledDate.toLocaleTimeString('ja-JP', timeFormatOptions);
                            }
                            
                            // === 修正: 備考欄のロジックを簡略化 ===
                            const remarksParts = [];
                            if (flight.flight_status === 'departed' || flight.flight_status === 'landed') {
                                 remarksParts.push('出発済み');
                            } else if (delayMinutes && typeof delayMinutes === 'number' && delayMinutes > 0) {
                                remarksParts.push(`${delayMinutes}分遅延`);
                            }
                            const remarksText = remarksParts.join(' ') || '---';

                            const tableRow = document.createElement('tr');
                            tableRow.innerHTML = `<td>${flightNumber}</td><td>${destination}</td><td>${scheduledTime}</td><td>${changedTimeText}</td><td>${gate}</td><td>${remarksText}</td>`;
                            flightDataTableBody.appendChild(tableRow);

                            const flightCard = document.createElement('div');
                            flightCard.classList.add('flight-card');
                            flightCard.innerHTML = `<div><span class="label">便名</span><span class="value">${flightNumber}</span></div><div><span class="label">行先</span><span class="value">${destination}</span></div><div><span class="label">定刻</span><span class="value">${scheduledTime}</span></div><div><span class="label">変更時刻</span><span class="value">${changedTimeText}</span></div><div><span class="label">搭乗口</span><span class="value">${gate}</span></div><div><span class="label">備考</span><span class="value">${remarksText}</span></div>`;
                            flightCardContainer.appendChild(flightCard);
                        });
                    })
                    .catch(error => {
                        console.error('データの取得に失敗しました:', error);
                        flightDataTableBody.innerHTML = `<tr><td colspan="6">情報の取得中にエラーが発生しました。</td></tr>`;
                        flightCardContainer.innerHTML = '<div class="flight-card"><div class="value" style="text-align:center;">情報の取得中にエラーが発生しました。</div></div>';
                    });
            };
            
            // === 修正: プルダウンの変更イベント ===
            airportSelect.addEventListener('change', () => {
                fetchAndDisplayFlights(airportSelect.value);
            });

            // 初回読み込み (既定の空港)
            fetchAndDisplayFlights(airportSelect.value);
        });
    </script>
</body>
</html>
